import{a as $,V as A,s as B,k as r,W as o,M as n,D as c,c as q,d as x,w as N,E as R,r as b,o as M,e as O}from"./index-Dj8CxrJe.js";const z={class:"ma-content-block p-4"},W={__name:"form",setup(C){var g,_,h,D,V,w,F;const u=$(),i=A(),I=B(),p=r(),f=r(((g=u.query)==null?void 0:g.tagId)??""),s=r(((_=u.query)==null?void 0:_.op)??""),v=r(((h=u.query)==null?void 0:h.key)??"");o.isEmpty(f.value)&&(n.error("缺少tagId参数"),c({path:u.fullPath})),o.isEmpty(s.value)&&(n.error("缺少op参数"),c({path:u.fullPath})),s.value==="edit"&&o.isEmpty(v.value)&&(n.error("缺少key参数"),c({path:u.fullPath})),i.formList[f.value]||(n.error("缺少Form配置"),c({path:u.fullPath}));const d=(D=i.formList[f.value])==null?void 0:D.config,l=r(s.value==="add"?(V=i.formList[f.value])==null?void 0:V.addData:i.formList[f.value].editData[v.value]),t=d==null?void 0:d.options,m=r(s.value==="add"?"新增":"编辑"),y=r(m.value+(((F=(w=d==null?void 0:d.options)==null?void 0:w.formOption)==null?void 0:F.tagName)??"未命名"));I.updateTagTitle(u.fullPath,` ${y.value} ${s.value==="edit"?" | "+v.value:""} `),d.sourceColumns.map(async a=>{a.dataIndex&&a.dataIndex.indexOf(".")>-1&&(l.value[a.dataIndex]=o.get(l.value,a.dataIndex)),s.value==="add"&&(a.addDefaultValue&&o.isFunction(a.addDefaultValue)?l.value[a.dataIndex]=await a.addDefaultValue(l.value):typeof a.addDefaultValue<"u"&&(l.value[a.dataIndex]=a.addDefaultValue)),s.value==="edit"&&(a.editDefaultValue&&o.isFunction(a.editDefaultValue)?l.value[a.dataIndex]=await a.editDefaultValue(l.value):typeof a.editDefaultValue<"u"&&(l.value[a.dataIndex]=a.editDefaultValue))});const E=()=>{window.history.back(-1)},P=async()=>{const a=p.value.getFormData();if(await p.value.validateForm())return!1;let e;if(s.value==="add"){if(o.isFunction(t.beforeAdd)&&!await t.beforeAdd(a))return!1;e=await t.add.api(a),o.isFunction(t.afterAdd)&&await t.afterAdd(e,a)}else{if(o.isFunction(t.beforeEdit)&&!await t.beforeEdit(a))return!1;e=await t.edit.api(a[t.pk],a),o.isFunction(t.afterEdit)&&await t.afterEdit(e,a)}e.success?(await p.value.resetForm(),n.success(e.message||`${m.value}成功！`),c({path:u.fullPath}),i.crudList[t.id]=!0):e.success===!1&&(typeof e.code>"u"||e.code!==200)&&(n.clear(),n.error(e.message||`${actionTitle.value}失败！`))};return(a,e)=>{const S=b("ma-form"),T=b("a-page-header");return M(),q("div",z,[x(T,{style:R({background:"var(--color-bg-2)"}),title:y.value,subtitle:`数据${m.value}页`,onBack:E},{default:N(()=>{var k;return[x(S,{modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=L=>l.value=L),columns:((k=O(d))==null?void 0:k.formColumns)??[],ref_key:"maFormRef",ref:p,onSubmit:P},null,8,["modelValue","columns"])]}),_:1},8,["style","title","subtitle"])])}}};export{W as default};
